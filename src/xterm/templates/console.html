<!doctype html>
<html lang="en" style="height: 100%; margin: 0;">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Console</title>

  <link rel="stylesheet" href="https://unpkg.com/xterm@3.6.0/dist/xterm.css" />

  <style>
    body, html {
      height: 100%;
      margin: 0;
    }
    #terminal {
      background: #333333
    }
    #terminal-container {
      padding: 0;
      height: calc(100% - 10px);
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #333;
      color: white;
      padding: 0.5rem;
    }
    #status {
      font-weight: bold;
      color: black;
    }
  </style>

  <script src="https://unpkg.com/xterm@3.6.0/dist/xterm.js"></script>
  <script src="https://unpkg.com/xterm@3.6.0/dist/addons/fit/fit.js"></script>
  <script src="https://unpkg.com/xterm@3.6.0/dist/addons/fullscreen/fullscreen.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.4.0/socket.io.js"></script>
</head>

<body style="height: 100%">

  <nav class="navbar navbar-dark bg-dark">
    <span style="font-size: medium;">Status: <span id="status">connecting...</span></span>
    <span id="console-info"></span>
  </nav>

  <div style=" width: 100%; height:100%;" id="terminal"></div>
  
  <script>

    // Better error handling with SweetAlert
    const showError = (error) => {
      Swal.fire({
        title: 'Error!',
        text: error.toString(),
        icon: 'error',
        confirmButtonText: 'OK'
      });
    };


    async function loadConsoleData(containerID, action) {
      try {
        const response = await fetch(`/api/console/${action}/${containerID}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        document.getElementById('console-info').textContent = 
          `Container Info: ${data.container_name} || ${data.image} || ${data.short_id} || ${data.command}`;
        setupWebSocketConnection(data.id, data.action);
      } catch (error) {
        showError(error);
      }
    }

    function setupWebSocketConnection(containerID, action){
      Terminal.applyAddon(fit);

      var socket = io.connect({transports: ["websocket", "polling"]});
      const status = document.getElementById("status")
  
      var term = new Terminal({
        cursorBlink: true,
      });
  
      term.open(document.getElementById('terminal'));
  
      term.on('key', (key, ev) => {
        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
        const ctrlKey = isMac ? ev.metaKey : ev.ctrlKey;
    
        if (ctrlKey && key === 'c' && term.hasSelection()) {
          // Copy to clipboard
          navigator.clipboard.writeText(term.getSelection());
        } else {
          // Send other key inputs to the server
          socket.emit("pty_input", { "input": key, "id": window.location.pathname.split("/")[2] });
        }
      });
  
      // Handle paste event
      term.on('paste', (data) => {
        socket.emit("pty_input", { "input": data, "id": window.location.pathname.split("/")[2] });
      });
  
      socket.on("pty_output", function (output) {
        //console.log(output["output"])
        term.write(output["output"])
      })
  
      socket.on("connect", () => {
        status.innerHTML = '<span style="background-color: lightgreen;">connected</span>'
        socket.emit(action, { "Id": containerID })
        term.focus()
      });
  
      socket.on("disconnect", () => {
        status.innerHTML = '<span style="background-color: #ff8383;">disconnected</span>'
  
      })

      function resize() {
        term.fit()
        socket.emit("resize", { "cols": term.cols, "rows": term.rows })
      }
  
      window.onresize = resize
      window.onload = resize
  
    }

    const containerID = location.pathname.split('/')[3];
    const action = location.pathname.split('/')[2];

    console.log(`Container ID:` + containerID);
    console.log(`Action:` + action);

    loadConsoleData(containerID, action);


  </script>
</body>

</html>